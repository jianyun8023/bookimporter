# Changelog

本文档记录 BookImporter 项目的所有重要变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [Unreleased]

### 新增
- `clname` 命令新增 `-r/--recursive` 参数，支持递归搜索子目录中的 EPUB 文件
- `clname` 命令新增 `-i/--ignore-errors` 参数，允许即使有失败也返回退出码 0
- `clname` 命令新增详细的帮助信息，包含使用示例和参数说明
- 添加参数验证机制：
  - 互斥参数检查（`--move-corrupted-to` 与 `--delete-corrupted`）
  - 参数依赖警告（`--force-delete` 需配合 `--delete-corrupted`）
  - 路径安全检查（防止将文件移动到源目录的子目录）
- 创建 CLAUDE.md 文档，为 AI 助手提供项目开发指南
- 创建 Changelog.md，规范版本变更记录
- 创建 docs 目录，整理项目文档结构

### 变更
- **[重要]** `clname` 命令默认行为改变：遇到错误时自动跳过并继续处理其他文件
  - 旧行为：默认遇到错误会停止（除非使用 `-j` 参数）
  - 新行为：默认跳过错误继续处理（更实用）
  - 退出码：有失败时返回 1（使用 `-i` 可返回 0）
- **[破坏性]** 移除 `-j/--skip` 参数，其功能已成为默认行为
- 大幅优化 `clname` 命令的帮助信息：
  - 添加详细的功能描述
  - 提供 5 个实用的使用示例
  - 改进所有参数说明，更加清晰易懂
  - 按功能分组显示参数
- 改进错误处理逻辑：
  - 遇到损坏文件时显示详细的文件路径和错误信息
  - 不再使用 `panic`，而是优雅地记录错误并继续
  - 统计信息更加详细，区分"跳过"和"失败"
- 改进文档，为所有命令示例添加递归搜索说明
- 将 LICENSE 移至 docs/LICENSE.md
- 将 SECURITY.md 移至 docs/SECURITY.md

### 修复
- 修复 `clname` 命令无法扫描子目录的问题（现在支持 `-r` 参数）
- 修复遇到损坏的 EPUB 文件时程序崩溃（panic）的问题
- 修复退出码不准确的问题（现在正确反映是否有失败）

### 移除
- **[破坏性]** 移除 `-j/--skip` 参数（功能已内置为默认行为）

## [0.1.0] - 2023-XX-XX

### 新增
- 实现 `clname` 命令：清理 EPUB 书籍标题中的无用描述符
  - 支持单个文件和批量处理
  - 支持尝试运行模式（--dotry）
  - 支持跳过错误（--skip）
  - 集成 Calibre 的 ebook-meta 工具
  
- 实现 `rename` 命令：批量重命名和移动文件
  - 支持自定义文件名模板
  - 支持递归搜索子目录
  - 支持移动文件到指定目录
  - 支持自定义起始序号
  - 支持多种文件格式过滤
  - 支持预览模式（--do-try）

- 实现 `version` 命令：显示程序版本信息

- 添加工具函数库
  - EPUB 标题清理逻辑
  - 文件操作工具函数
  - 单元测试覆盖

### 技术细节
- 使用 Go 1.18+ 开发
- 集成 Cobra CLI 框架
- 集成 epub 解析库
- 完善的命令行参数支持

## 版本说明

### 版本号规则
- **主版本号 (Major)**: 不兼容的 API 变更
- **次版本号 (Minor)**: 向下兼容的功能性新增
- **修订号 (Patch)**: 向下兼容的问题修正

### 变更类型
- **新增 (Added)**: 新功能
- **变更 (Changed)**: 对现有功能的变更
- **弃用 (Deprecated)**: 即将移除的功能
- **移除 (Removed)**: 已移除的功能
- **修复 (Fixed)**: 任何 bug 修复
- **安全 (Security)**: 修复安全问题

---

## 如何维护此文档

### 添加新版本
1. 在 `[Unreleased]` 下方添加新版本标题
2. 使用格式：`## [版本号] - YYYY-MM-DD`
3. 按类型组织变更内容

### 记录变更
在开发过程中，将变更添加到 `[Unreleased]` 部分：

```markdown
## [Unreleased]

### 新增
- 添加了某某新功能

### 修复
- 修复了某某问题
```

### 发布新版本
发布时，将 `[Unreleased]` 的内容移到新版本标题下：

```markdown
## [Unreleased]

## [1.0.0] - 2025-11-28

### 新增
- 添加了某某新功能

### 修复
- 修复了某某问题
```

### 示例

```markdown
## [Unreleased]

### 新增
- 添加对 PDF 文件的元数据清理支持

## [1.1.0] - 2025-12-01

### 新增
- 添加 `export` 命令，支持导出书籍列表
- 支持 JSON 和 CSV 格式导出

### 变更
- 优化 `rename` 命令的性能
- 改进错误提示信息

### 修复
- 修复 Windows 平台路径分隔符问题
- 修复大文件处理时的内存泄漏

## [1.0.0] - 2025-11-28

### 新增
- 首个稳定版本发布
```

---

## 迁移指南

### 从旧版本升级

如果你之前使用了 `-j/--skip` 参数：

**旧用法（不再可用）:**
```bash
./bookimporter clname -p ./books/ -j
```

**新用法（-j 已是默认行为）:**
```bash
# 默认就会跳过错误
./bookimporter clname -p ./books/

# 如果需要忽略退出码（之前 -j 的完整效果）
./bookimporter clname -p ./books/ -i
```

### 退出码变更

**新行为:**
- 所有文件处理成功：退出码 `0`
- 有文件处理失败（默认）：退出码 `1`
- 有文件处理失败但使用 `-i` 参数：退出码 `0`

**脚本适配建议:**
```bash
# 如果你的脚本依赖退出码
if ./bookimporter clname -p ./books/ -r; then
    echo "处理成功"
else
    echo "有失败（但已处理完所有文件）"
fi

# 如果你不关心是否有失败
./bookimporter clname -p ./books/ -r -i
```

---

最后更新: 2025-11-28

